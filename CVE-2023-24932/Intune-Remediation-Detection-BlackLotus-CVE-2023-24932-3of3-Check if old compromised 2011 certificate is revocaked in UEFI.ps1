# BlackLotus CVE-2023-24932 mitigation check 3/3
# Check if compromised old Microsoft Windows Production PCA 2011
# certificate is revocated in UEFI database
#
# Petri.Paavola@yodamiitti.fi
# Microsoft MVP - Windows and Devices
# 24.5.2024
#
# Read Microsoft mitigation instructions from
# https://support.microsoft.com/en-au/topic/kb5025885-how-to-manage-the-windows-boot-manager-revocations-for-secure-boot-changes-associated-with-cve-2023-24932-41a975df-beb2-40c1-99a3-b3ff139f832d


# Check if compromised old Microsoft Windows Production PCA 2011 certificate
# is added to UEFI certificate revocation database
$CompromisedOldUEFICertificateRevocated = [System.Text.Encoding]::ASCII.GetString((Get-SecureBootUEFI dbx).bytes) -match 'Microsoft Windows Production PCA 2011'

if($CompromisedOldUEFICertificateRevocated) {
	# Compromised old Windows Production PCA 2011 certificate is revocated in UEFI certificate database
	
	Write-Host "Compromised old Windows Production PCA 2011 certificate is revocated in UEFI certificate database"
	Exit 0

} else {
	# Compromised old Windows Production PCA 2011 certificate is NOT revocated in UEFI certificate database

	Write-Host "Compromised old Windows Production PCA 2011 certificate is NOT revocated in UEFI certificate database"
	Exit 1
}
