# BlackLotus CVE-2023-24932 mitigation check 2/3
#
# Check if Windows UEFI CA 2023 certificate
# is installed to current running Windows boot manager
#
# Petri.Paavola@yodamiitti.fi
# Microsoft MVP - Windows and Devices
# 24.5.2024
#
# Read Microsoft mitigation instructions from
# https://support.microsoft.com/en-au/topic/kb5025885-how-to-manage-the-windows-boot-manager-revocations-for-secure-boot-changes-associated-with-cve-2023-24932-41a975df-beb2-40c1-99a3-b3ff139f832d
#
#
# This is heavily influenced by GaryTown script :) Thanks!
#   https://github.com/gwblok/garytown/blob/master/ConfigMgr/Baselines/CVE-2023-24932/KB5025885-CheckCompliance.ps1
#
#
# You may also want to read GaryTown blogs about this issue
#  https://garytown.com/configmgr-task-sequence-kb5025885-how-to-manage-the-windows-boot-manager-revocations-for-secure-boot-changes-associated-with-cve-2023-24932
#
#

# Get EFI folder path (without drive letter)
$Volume = Get-Volume | Where-Object {$_.FileSystemType -eq "FAT32" -and $_.DriveType -eq "Fixed"}
$SystemDisk = Get-Disk | Where-Object {$_.IsSystem -eq $true}
$SystemPartition = Get-Partition -DiskNumber $SystemDisk.DiskNumber | Where-Object {$_.IsSystem -eq $true}
$SystemVolume = $Volume | Where-Object {$_.UniqueId -match $SystemPartition.Guid}
$FilePath = "$($SystemVolume.Path)\EFI\Microsoft\Boot\bootmgfw.efi"

# Get bootmgfw.efi Boot Manager certificates
$CertCollection = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2Collection
$CertCollection.Import($FilePath, $null, 'DefaultKeySet')


If ($CertCollection.Subject -like "*Windows UEFI CA 2023*") {
	# Windows UEFI CA 2023 certificate is installed to current running Windows Boot Manager
	
	Write-Host "Windows UEFI CA 2023 certificate is installed to current running Windows Boot Manager"
	Exit 0
	
} else {
	# Windows UEFI CA 2023 certificate is NOT installed to current running Windows Boot Manager
	
	Write-Host "Windows UEFI CA 2023 certificate is NOT installed to current running Windows Boot Manager"
	Exit 1
}
